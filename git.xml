<project name="git">
	<import>
		<url url="${SCRIPTS_BASE}/linux/core.xml" />
		<url url="${SCRIPTS_BASE}/ant-contrib.xml" />
	</import>	

	<get src="${SCRIPTS_BASE}/git/git-wrapper.sh"
	     dest="${SCRIPTS_TMP_DIR}/git-wrapper.sh"
	     usetimestamp="true" />

	<macrodef name="git">
		<attribute name="exec"/>
		<attribute name="privateKey" default=""/>
		<attribute name="dir" default="${basedir}"/>
		<attribute name="debug" default="false"/>
		<sequential>	
			<run exec="chmod +x ${SCRIPTS_TMP_DIR}/git-wrapper.sh"/>		

			<var name="cmd" value="${SCRIPTS_TMP_DIR}/git-wrapper.sh" />
			<if>
				<not>
					<equals arg1="@{privateKey}" arg2=""/>
				</not>
				<then>
					<var name="cmd" value="${cmd} -i @{privateKey}" />
				</then>
			</if>
			<var name="cmd" value="${cmd} @{exec}" />

			<if>
				<istrue value="@{debug}"/>
				<then>
					<echo message="[GIT](${dir}): ${cmd}"/>
				</then>
			</if>

			<run exec="${cmd}" dir="@{dir}" />
			
			<var name="cmd" unset="true"/>
		</sequential>
	</macrodef>

	<macrodef name="git-download">
		<attribute name="repository"/>
		<attribute name="workspace"/>
		<attribute name="remote" default="origin"/>
		<attribute name="branch" default="master"/>
		<attribute name="privateKey" default=""/>		
		<attribute name="debug" default="false"/>
		<sequential>
			<if>
				<not><resourceexists>
					<file file="${workspace}"/>
				</resourceexists></not>
				<then>
					<mkdir dir="${workspace}"/>		
				</then>
			</if>	
			
			<if>
				<resourceexists>
					<file file="${workspace}/.git"/>
				</resourceexists>
				<then>
					<git dir="${workspace}" exec="pull @{remote} @{branch}" 
						debug="@{debug}" privateKey="@{privateKey}"/>
				</then>
				<else>
					<git dir="${workspace}" exec="clone @{repository} ." 
						debug="@{debug}" privateKey="@{privateKey}"/>
				</else>
			</if>
		</sequential>
	</macrodef>
</project>